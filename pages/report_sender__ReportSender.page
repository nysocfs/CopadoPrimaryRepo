<apex:page controller="report_sender.DashboardController" showHeader="false" title="Peeklogic Report Sender">
    <apex:slds >
        <apex:form rendered="true">
            
            <script src="/soap/ajax/40.0/connection.js" type="text/javascript" />
            <script src="/soap/ajax/40.0/apex.js" type="text/javascript" />
            <article class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div style="display: inline-block; width: 100%;">
                            <div style="text-align: start; font-family: 'Arial';font-size: 14px;">
                                <p style="font-size: 25px;">Welcome to Peeklogic Report Sender</p>
                                <p style="font-size: 14px;">
                                    Peeklogic Report Sender allows to send reports in attachments unlimited and for free in CSV or XLS format to your client's external email address and teams outside Salesforce.
                                </p>
                                <p>
                                    The AppExchange App was developed by <b>Peeklogic</b>, the <b>Salesforce Development Company</b>. Need help with Salesforce Custom Development?
                                </p>
                                <br/>
                                <apex:outputLink value="https://www.peeklogic.com/our-products/salesforce-report-sender">Application Manual</apex:outputLink>
                                <br/>
                                <apex:outputLink value="mailto:info@peeklogic.com">Contact Us</apex:outputLink>
                            </div>
                            <div style="font-size: 18px;  float: right; display:flex; "> Powered by
                                <apex:outputLink value="https://peeklogic.com" style="padding-left: 5px;">
                                    <apex:image url="{!URLFOR($Resource.report_sender__Peeklogic,'images/peeklogic.png')}" width="100" height="50" />
                                </apex:outputLink>
                            </div>
                        </div>

                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title"></h2>
                        </div>
                    </header>
                </div>
            </article>
            <apex:actionFunction action="{!testinput}" name="passToController" rerender="test">
                <apex:param value="" name="inpval"/>
                </apex:actionFunction>
                <!--<div style="width:50%">
                    <script>
                        document.getElementById('inpval').innerHTML = '{!dashboardHtml}';
                    </script>
                
                  </div>-->                          
        </apex:form>
                          
        <script>
                                       
              function testinputJS(){
                var str = document.getElementById('testinput').value;
                console.log('str = ',str);
                passToController(str);
            }
            var SAMPLEMC = "{!$MessageChannel.report_sender__MessageChannel__c}";
            var subscription;

            function handleMessage(message) {
                let data = JSON.stringify(message);
                console.log('Data result:', data);
                if (message.recordData != undefined) {
                    passToController(data);
                } else {
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.DashboardController.sendEmailToUser}', data,
                    function (result, event) {

                    }
                );
                }
            }

            function subscribeMC() {
                console.log(subscription);
                if (!subscription) {
                    subscription = sforce.one.subscribe(SAMPLEMC, handleMessage);
                }
            }

            function unsubscribeMC() {
                if (subscription) {
                    sforce.one.unsubscribe(subscription);
                    subscription = null;
                }
            }

            window.onload = function () {
                subscribeMC();
            };

        </script>
    </apex:slds>
</apex:page>